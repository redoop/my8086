# Intel 8086 指令集实现清单

## 概述

Intel 8086 处理器支持约 **100+ 条指令**，分为以下几大类：
- 数据传送指令
- 算术运算指令
- 逻辑运算指令
- 移位和循环指令
- 字符串操作指令
- 控制转移指令
- 处理器控制指令

本文档列出所有 8086 指令，并标注 MyCPU8086 的实现状态。

**图例**:
- ✅ 已实现
- ⚠️ 部分实现
- ❌ 未实现
- 🔄 计划中

---

## 当前实现统计

### 初始版本 (v0.1.0)
| 类别 | 总数 | 已实现 | 实现率 |
|------|------|--------|--------|
| 数据传送 | 14 | 1 | 7.1% |
| 算术运算 | 20 | 1 | 5.0% |
| 逻辑运算 | 12 | 0 | 0% |
| 移位循环 | 8 | 0 | 0% |
| 字符串操作 | 10 | 0 | 0% |
| 控制转移 | 25 | 0 | 0% |
| 处理器控制 | 15 | 1 | 6.7% |
| **总计** | **104** | **3** | **2.9%** |

### ⭐ Milestone 1 MVP (v0.2.0) - 当前版本
| 类别 | 总数 | 已实现 | 实现率 |
|------|------|--------|--------|
| 数据传送 | 14 | 5 | 35.7% |
| 算术运算 | 20 | 10 | 50.0% |
| 逻辑运算 | 12 | 0 | 0% |
| 移位循环 | 8 | 0 | 0% |
| 字符串操作 | 10 | 0 | 0% |
| 控制转移 | 25 | 1 | 4.0% |
| 处理器控制 | 15 | 1 | 6.7% |
| **总计** | **104** | **15** | **14.4%** |

---

## 1. 数据传送指令 (Data Transfer Instructions)

| 指令 | 操作码 | 功能 | 状态 | 备注 |
|------|--------|------|------|------|
| MOV reg, reg | 89/8B | 寄存器间传送 | ✅ | MVP: 0x89 |
| MOV reg, mem | 8B | 内存到寄存器 | ❌ | - |
| MOV mem, reg | 89 | 寄存器到内存 | ❌ | - |
| MOV reg, imm | B0-BF | 立即数到寄存器 | ✅ | MVP: 0xB8-0xBB (AX-DX) |
| MOV mem, imm | C6/C7 | 立即数到内存 | ❌ | - |
| PUSH reg | 50-57 | 压栈 | ❌ | - |
| PUSH mem | FF/6 | 内存压栈 | ❌ | - |
| POP reg | 58-5F | 出栈 | ❌ | - |
| POP mem | 8F/0 | 内存出栈 | ❌ | - |
| XCHG reg, reg | 86/87 | 交换寄存器 | ❌ | - |
| XCHG AX, reg | 90-97 | AX 交换 | ❌ | - |
| IN AL, port | E4 | 端口输入 | ❌ | - |
| OUT port, AL | E6 | 端口输出 | ❌ | - |
| LEA | 8D | 加载有效地址 | ❌ | - |

**实现状态**: 5/14 (35.7%) ⭐ Milestone 1


## 2. 算术运算指令 (Arithmetic Instructions)

| 指令 | 操作码 | 功能 | 状态 | 备注 |
|------|--------|------|------|------|
| ADD reg, reg | 01/03 | 加法 | ✅ | MVP: 0x01 |
| ADD reg, mem | 03 | 寄存器加内存 | ❌ | - |
| ADD mem, reg | 01 | 内存加寄存器 | ❌ | - |
| ADD reg, imm | 80/83 | 立即数加法 | ❌ | - |
| ADC | 10-15 | 带进位加法 | ❌ | - |
| SUB | 28-2D | 减法 | ✅ | MVP: 0x29 |
| SBB | 18-1D | 带借位减法 | ❌ | - |
| INC reg | 40-47 | 寄存器加1 | ✅ | MVP: 0x40-0x43 (AX-BX) |
| INC mem | FE/0, FF/0 | 内存加1 | ❌ | - |
| DEC reg | 48-4F | 寄存器减1 | ✅ | MVP: 0x48-0x4B (AX-BX) |
| DEC mem | FE/1, FF/1 | 内存减1 | ❌ | - |
| NEG | F6/3, F7/3 | 取负 | ❌ | - |
| CMP | 38-3D | 比较 | ✅ | MVP: 0x39 |
| MUL | F6/4, F7/4 | 无符号乘法 | ❌ | - |
| IMUL | F6/5, F7/5 | 有符号乘法 | ❌ | - |
| DIV | F6/6, F7/6 | 无符号除法 | ❌ | - |
| IDIV | F6/7, F7/7 | 有符号除法 | ❌ | - |
| CBW | 98 | 字节扩展为字 | ❌ | - |
| CWD | 99 | 字扩展为双字 | ❌ | - |
| AAA | 37 | ASCII 调整加法 | ❌ | - |
| AAS | 3F | ASCII 调整减法 | ❌ | - |

**实现状态**: 10/20 (50.0%) ⭐ Milestone 1


## 3. 逻辑运算指令 (Logical Instructions)

| 指令 | 操作码 | 功能 | 状态 | 备注 |
|------|--------|------|------|------|
| AND reg, reg | 21/23 | 逻辑与 | ❌ | - |
| AND reg, imm | 80/4, 83/4 | 立即数与 | ❌ | - |
| OR reg, reg | 09/0B | 逻辑或 | ❌ | - |
| OR reg, imm | 80/1, 83/1 | 立即数或 | ❌ | - |
| XOR reg, reg | 31/33 | 异或 | ❌ | - |
| XOR reg, imm | 80/6, 83/6 | 立即数异或 | ❌ | - |
| NOT | F6/2, F7/2 | 逻辑非 | ❌ | - |
| TEST reg, reg | 85 | 测试 | ❌ | - |
| TEST reg, imm | A8/A9 | 立即数测试 | ❌ | - |
| SHL/SAL | D0-D3/4 | 左移 | ❌ | - |
| SHR | D0-D3/5 | 逻辑右移 | ❌ | - |
| SAR | D0-D3/7 | 算术右移 | ❌ | - |

**实现状态**: 0/12 (0%)


## 4. 移位和循环指令 (Shift and Rotate Instructions)

| 指令 | 操作码 | 功能 | 状态 | 备注 |
|------|--------|------|------|------|
| ROL | D0-D3/0 | 循环左移 | ❌ | - |
| ROR | D0-D3/1 | 循环右移 | ❌ | - |
| RCL | D0-D3/2 | 带进位循环左移 | ❌ | - |
| RCR | D0-D3/3 | 带进位循环右移 | ❌ | - |
| SHL/SAL | D0-D3/4 | 算术/逻辑左移 | ❌ | - |
| SHR | D0-D3/5 | 逻辑右移 | ❌ | - |
| SAR | D0-D3/7 | 算术右移 | ❌ | - |
| SHLD | 0F A4 | 双精度左移 | ❌ | 80186+ |

**实现状态**: 0/8 (0%)


## 5. 字符串操作指令 (String Instructions)

| 指令 | 操作码 | 功能 | 状态 | 备注 |
|------|--------|------|------|------|
| MOVS | A4/A5 | 串传送 | ❌ | - |
| MOVSB | A4 | 字节串传送 | ❌ | - |
| MOVSW | A5 | 字串传送 | ❌ | - |
| CMPS | A6/A7 | 串比较 | ❌ | - |
| SCAS | AE/AF | 串扫描 | ❌ | - |
| LODS | AC/AD | 串加载 | ❌ | - |
| STOS | AA/AB | 串存储 | ❌ | - |
| REP | F3 | 重复前缀 | ❌ | - |
| REPE/REPZ | F3 | 相等时重复 | ❌ | - |
| REPNE/REPNZ | F2 | 不相等时重复 | ❌ | - |

**实现状态**: 0/10 (0%)


## 6. 控制转移指令 (Control Transfer Instructions)

| 指令 | 操作码 | 功能 | 状态 | 备注 |
|------|--------|------|------|------|
| JMP short | EB | 短跳转 | ✅ | MVP: 0xEB |
| JMP near | E9 | 近跳转 | ❌ | - |
| JMP far | EA | 远跳转 | ❌ | - |
| JE/JZ | 74 | 相等/零跳转 | ❌ | - |
| JNE/JNZ | 75 | 不相等/非零跳转 | ❌ | - |
| JG/JNLE | 7F | 大于跳转 | ❌ | - |
| JGE/JNL | 7D | 大于等于跳转 | ❌ | - |
| JL/JNGE | 7C | 小于跳转 | ❌ | - |
| JLE/JNG | 7E | 小于等于跳转 | ❌ | - |
| JA/JNBE | 77 | 无符号大于 | ❌ | - |
| JAE/JNB | 73 | 无符号大于等于 | ❌ | - |
| JB/JNAE | 72 | 无符号小于 | ❌ | - |
| JBE/JNA | 76 | 无符号小于等于 | ❌ | - |
| JS | 78 | 符号位为1跳转 | ❌ | - |
| JNS | 79 | 符号位为0跳转 | ❌ | - |
| JO | 70 | 溢出跳转 | ❌ | - |
| JNO | 71 | 不溢出跳转 | ❌ | - |
| JP/JPE | 7A | 奇偶位为1跳转 | ❌ | - |
| JNP/JPO | 7B | 奇偶位为0跳转 | ❌ | - |
| JCXZ | E3 | CX为0跳转 | ❌ | - |
| LOOP | E2 | 循环 | ❌ | - |
| LOOPE/LOOPZ | E1 | 相等时循环 | ❌ | - |
| LOOPNE/LOOPNZ | E0 | 不相等时循环 | ❌ | - |
| CALL near | E8 | 近调用 | ❌ | - |
| CALL far | 9A | 远调用 | ❌ | - |
| RET | C3 | 近返回 | ❌ | - |
| RET far | CB | 远返回 | ❌ | - |
| INT | CD | 软件中断 | ❌ | - |
| INTO | CE | 溢出中断 | ❌ | - |
| IRET | CF | 中断返回 | ❌ | - |

**实现状态**: 1/25 (4.0%) ⭐ Milestone 1


## 7. 处理器控制指令 (Processor Control Instructions)

| 指令 | 操作码 | 功能 | 状态 | 备注 |
|------|--------|------|------|------|
| HLT | F4 | 停机 | ✅ | 已实现 |
| NOP | 90 | 空操作 | ❌ | - |
| WAIT | 9B | 等待 | ❌ | - |
| ESC | D8-DF | 协处理器转义 | ❌ | - |
| LOCK | F0 | 总线锁定前缀 | ❌ | - |
| CLC | F8 | 清除进位标志 | ❌ | - |
| STC | F9 | 设置进位标志 | ❌ | - |
| CMC | F5 | 进位标志取反 | ❌ | - |
| CLD | FC | 清除方向标志 | ❌ | - |
| STD | FD | 设置方向标志 | ❌ | - |
| CLI | FA | 清除中断标志 | ❌ | - |
| STI | FB | 设置中断标志 | ❌ | - |
| LAHF | 9F | 标志送AH | ❌ | - |
| SAHF | 9E | AH送标志 | ❌ | - |
| PUSHF | 9C | 标志压栈 | ❌ | - |
| POPF | 9D | 标志出栈 | ❌ | - |

**实现状态**: 1/15 (6.7%)


---

## MyCPU8086 当前实现详情

### ✅ 已实现的指令 (3条)

#### 1. MOV AX, immediate (0xB8)
```scala
// 操作码: 0xB8
// 格式: [15:8]=0xB8, [7:0]=立即数
is(0xB8.U) {
  ax := instruction(7, 0) ## 0.U(8.W)
  state := sFetch
}
```
**功能**: 将立即数加载到 AX 寄存器的高字节  
**限制**: 
- 只支持 8 位立即数
- 只能操作 AX 寄存器
- 标准 8086 支持 16 位立即数和所有通用寄存器

#### 2. ADD AX, BX (0x01)
```scala
// 操作码: 0x01
is(0x01.U) {
  val result = ax + bx
  ax := result
  flags := Cat(result === 0.U, flags(14, 0))
  state := sFetch
}
```
**功能**: AX = AX + BX  
**限制**:
- BX 寄存器未实现（值为 0）
- 只更新零标志位
- 标准 8086 支持所有寄存器组合和完整标志位

#### 3. HLT (0xF4)
```scala
// 操作码: 0xF4
is(0xF4.U) {
  state := sHalt
}
```
**功能**: 停止 CPU 执行  
**状态**: ✅ 完全实现

---

## 实现优先级建议

### 🔥 高优先级（核心功能）

#### Phase 1: 基础寄存器和数据传送
- [ ] 实现 BX, CX, DX 寄存器
- [ ] 完整的 MOV reg, reg
- [ ] 完整的 MOV reg, imm (16位)
- [ ] MOV reg, mem
- [ ] MOV mem, reg

#### Phase 2: 基础算术运算
- [ ] 完整的 ADD 指令（所有寻址模式）
- [ ] SUB 指令
- [ ] INC/DEC 指令
- [ ] CMP 指令
- [ ] 完整的标志位更新（CF, ZF, SF, OF, PF, AF）

#### Phase 3: 基础控制转移
- [ ] JMP 指令
- [ ] 条件跳转（JE, JNE, JG, JL 等）
- [ ] CALL/RET 指令
- [ ] 栈操作（PUSH/POP）

### ⚡ 中优先级（扩展功能）

#### Phase 4: 逻辑运算
- [ ] AND, OR, XOR, NOT
- [ ] TEST 指令
- [ ] 移位指令（SHL, SHR, SAR）

#### Phase 5: 高级算术
- [ ] MUL/IMUL（乘法）
- [ ] DIV/IDIV（除法）
- [ ] ADC/SBB（带进位运算）

### 🌟 低优先级（高级功能）

#### Phase 6: 字符串操作
- [ ] MOVS, CMPS, SCAS
- [ ] LODS, STOS
- [ ] REP 前缀

#### Phase 7: 系统功能
- [ ] 中断支持（INT, IRET）
- [ ] 段寄存器操作
- [ ] I/O 指令（IN, OUT）

---

## 实现路线图

### Milestone 1: 最小可用系统 (MVP)
**目标**: 能运行简单的计算程序  
**指令数**: ~15 条  
**预计工作量**: 2-3 周

- [x] HLT
- [x] MOV AX, imm (部分)
- [x] ADD AX, BX (部分)
- [ ] MOV reg, reg (4条)
- [ ] ADD/SUB reg, reg (8条)
- [ ] INC/DEC reg (8条)
- [ ] JMP (1条)
- [ ] CMP (1条)

### Milestone 2: 基础功能完整
**目标**: 支持基本的程序控制流  
**指令数**: ~40 条  
**预计工作量**: 4-6 周

- [ ] 所有 MOV 变体
- [ ] 完整的算术运算
- [ ] 条件跳转
- [ ] CALL/RET
- [ ] PUSH/POP
- [ ] 逻辑运算

### Milestone 3: 标准兼容
**目标**: 兼容大部分 8086 程序  
**指令数**: ~80 条  
**预计工作量**: 8-12 周

- [ ] 乘除法
- [ ] 字符串操作
- [ ] 中断支持
- [ ] 完整的寻址模式

---

## 测试覆盖率

### 当前测试状态

| 指令 | 单元测试 | 集成测试 | 状态 |
|------|---------|---------|------|
| MOV AX, imm | ⚠️ | ⚠️ | 部分测试 |
| ADD AX, BX | ⚠️ | ⚠️ | 部分测试 |
| HLT | ✅ | ✅ | 完整测试 |

### 测试文件
- `src/test/scala/cpu8086/MyCPU8086Test.scala` - 基础功能测试
- `src/test/scala/cpu8086/ProgramTest.scala` - 程序执行测试
- `src/test/scala/cpu8086/ProgramWithMemoryTest.scala` - 详细分析测试

---

## 参考资料

1. **Intel 8086 Family User's Manual** (1979)
   - 官方指令集参考
   - 完整的操作码表

2. **The 8086 Primer** by Stephen P. Morse
   - 指令详细说明
   - 编程示例

3. **x86 Instruction Set Reference**
   - https://www.felixcloutier.com/x86/
   - 现代参考（包含 8086）

4. **8086 Opcode Map**
   - http://ref.x86asm.net/coder.html
   - 完整的操作码映射表

---

## 贡献指南

如果你想为 MyCPU8086 添加新指令，请遵循以下步骤：

1. **选择指令**: 从本清单中选择未实现的指令
2. **实现指令**: 在 `src/main/scala/cpu8086/CPU8086.scala` 中添加
3. **编写测试**: 在 `src/test/scala/cpu8086/` 中添加测试
4. **更新文档**: 更新本清单和相关文档
5. **提交 PR**: 提交到 GitHub

### 指令实现模板

```scala
// 在 sExecute 状态中添加
is(0xXX.U) {  // 替换为实际操作码
  // 1. 解码操作数
  val operand = instruction(7, 0)
  
  // 2. 执行操作
  val result = /* 计算结果 */
  
  // 3. 更新寄存器
  register := result
  
  // 4. 更新标志位
  flags := updateFlags(result)
  
  // 5. 返回 FETCH 状态
  state := sFetch
}
```

---

## 更新日志

- **2025-11-25**: 创建初始清单
  - 统计 104 条 8086 指令
  - 标注 3 条已实现指令
  - 制定实现路线图

---

**最后更新**: 2025-11-25  
**文档版本**: 1.0  
**MyCPU8086 版本**: 0.1.0
